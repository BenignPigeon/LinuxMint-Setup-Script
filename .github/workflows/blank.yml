name: Create Beta Pre-Release

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to create releases and upload assets

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necessary to fetch all tags for versioning

      - name: Zip Repository
        run: |
          # Zip the current directory, excluding hidden git files
          zip -r LinuxMint-Setup-Script.zip . -x "*.git*" ".github*"

      - name: Determine Next Beta Version
        id: versioning
        run: |
          # Get the latest tag, default to v0.0.0 if none exist
          LATEST_TAG=$(git tag --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then LATEST_TAG="v0.0.0"; fi
          
          echo "Latest tag found: $LATEST_TAG"

          if [[ "$LATEST_TAG" =~ -beta\.([0-9]+)$ ]]; then
            # If it's already a beta, increment N
            VERSION_BASE="${LATEST_TAG%-beta.*}"
            BETA_NUMBER="${BASH_REMATCH[1]}"
            NEXT_BETA=$((BETA_NUMBER + 1))
            NEW_TAG="${VERSION_BASE}-beta.${NEXT_BETA}"
          else
            # If it's a stable tag, start at beta.1 of that version
            # (Note: You might want to increment the patch version here if following SemVer)
            NEW_TAG="${LATEST_TAG}-beta.1"
          fi

          echo "New tag: $NEW_TAG"
          echo "tag_name=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.versioning.outputs.tag_name }}
          name: "Pre-release ${{ steps.versioning.outputs.tag_name }}"
          prerelease: true
          files: LinuxMint-Setup-Script.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}