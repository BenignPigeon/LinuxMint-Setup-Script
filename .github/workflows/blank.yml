name: Create Nightly Pre-Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Optional: Runs automatically every night at midnight UTC

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Zip Repository
        run: |
          zip -r LinuxMint-Setup-Script.zip . -x "*.git*" ".github*"

      - name: Set Nightly Version
        id: versioning
        run: |
          # Create a tag based on the current date
          TAG_DATE=$(date +'%Y.%m.%d')
          echo "tag_name=nightly-$TAG_DATE" >> $GITHUB_OUTPUT
          echo "display_date=$(date +'%B %d, %Y')" >> $GITHUB_OUTPUT

      - name: Delete Old Nightly Releases
        run: |
          # 1. Get the IDs/Tags of all releases marked as 'Pre-release'
          # 2. Delete them to keep only the newest one
          # Using 'gh release list' and filtering for the 'Pre-release' label
          gh release list --limit 50 | grep -i "Pre-release" | awk '{print $1}' | while read -r old_tag; do
            echo "Removing old nightly: $old_tag"
            gh release delete "$old_tag" --yes --cleanup-tag
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.versioning.outputs.tag_name }}
          name: "Nightly Build (${{ steps.versioning.outputs.display_date }})"
          body: |
            This is an automated nightly build of the Linux Mint Setup Script.
            **Built on:** ${{ steps.versioning.outputs.display_date }}
            
            *Note: This release is updated daily. Older nightlies are automatically removed.*
          prerelease: true
          files: LinuxMint-Setup-Script.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}