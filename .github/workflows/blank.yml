name: Create Beta Pre-Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Zip Repository
        run: |
          zip -r LinuxMint-Setup-Script.zip . -x "*.git*" ".github*"

      - name: Determine Next Beta Version
        id: versioning
        run: |
          # Get latest tag or default
          LATEST_TAG=$(git tag --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then LATEST_TAG="v1.0.0"; fi
          
          if [[ "$LATEST_TAG" =~ -beta\.([0-9]+)$ ]]; then
            # Increment existing beta number
            VERSION_BASE="${LATEST_TAG%-beta.*}"
            BETA_NUMBER="${BASH_REMATCH[1]}"
            NEXT_BETA=$((BETA_NUMBER + 1))
            NEW_TAG="${VERSION_BASE}-beta.${NEXT_BETA}"
          else
            # Increment patch for new beta cycle (e.g., 1.0 -> v1.0.1-beta.1)
            CLEAN_TAG=${LATEST_TAG#v}
            # Handles X.Y or X.Y.Z formats
            NEXT_VERSION=$(echo $CLEAN_TAG | awk -F. '{if (NF==1) print $1".0.1"; else if (NF==2) print $1"."$2".1"; else {$NF = $NF + 1; print $0}}' OFS=.)
            NEW_TAG="v${NEXT_VERSION}-beta.1"
          fi

          echo "tag_name=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Delete Old Beta Releases
        run: |
          # Fetch all releases, filter for those marked as "prerelease", and delete them
          # This keeps the UI clean so only the latest beta exists.
          gh release list --limit 100 | grep "Pre-release" | awk '{print $1}' | while read -r tag; do
            echo "Deleting old pre-release: $tag"
            gh release delete "$tag" --yes --cleanup-tag
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.versioning.outputs.tag_name }}
          name: "Pre-release ${{ steps.versioning.outputs.tag_name }}"
          prerelease: true
          files: LinuxMint-Setup-Script.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}